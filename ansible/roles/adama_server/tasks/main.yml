---

- name: Get adama code
  git:
    repo: https://github.com/waltermoreira/adama
    dest: /home/adama/adama
    version: "{{ branch | default(master) }}"
    update: yes
  sudo: yes
  sudo_user: adama
  notify:
    - Rebuild containers
    - Reload adama server

- name: Install all Python requirements
  pip: requirements=/home/adama/adama/dev_requirements.txt
  sudo: yes

- name: Install adama itself
  pip: name=/home/adama/adama state=latest
  sudo: yes

- set_fact:
    swagger_html="/usr/local/lib/python2.7/dist-packages/flask_restful_swagger/html.py"
    supervisord_conf_dir="/etc/supervisor/conf.d"
    supervisord_conf_ext="conf"
    supervisord_service="supervisor"
  when: ansible_os_family == "Debian"

- set_fact:
    swagger_html="/usr/lib/python2.7/site-packages/flask_restful_swagger/html.py"
    supervisord_conf_dir="/etc/supervisord.d"
    supervisord_conf_ext="ini"
    supervisord_service="supervisord"
  when: ansible_os_family == "RedHat"

- name: Patch swagger ui
  lineinfile:
    dest: "{{ swagger_html }}"
    regexp: "^(.*)docExpansion:(.*)$"
    line: '\1docExpansion: "full"'
    state: present
    backrefs: yes
  sudo: yes

- name: Setup local config file
  ini_file:
    dest: /home/adama/.adama.conf
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
  sudo: yes
  sudo_user: adama
  with_items: config
  notify: Document local config file

- name: Add adama to supervisor
  template:
    src=adama.ini.j2
    dest={{ supervisord_conf_dir }}/adama.{{ supervisord_conf_ext }}
  sudo: yes
  notify:
    - Reload adama server

- name: Make sure supervisor sees the new .conf file
  service: name={{ supervisord_service }} state=restarted
  sudo: yes

- name: Make sure the adama server is started
  supervisorctl: name=adama state=started
  sudo: yes
